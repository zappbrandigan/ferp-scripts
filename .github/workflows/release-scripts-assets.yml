name: Build Script Assets

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-assets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build namespace assets
        run: |
          python - <<'PY'
          from __future__ import annotations

          import json
          import zipfile
          from pathlib import Path

          scripts_root = Path(".").resolve()
          dist = scripts_root / "dist"
          dist.mkdir(parents=True, exist_ok=True)

          namespaces: list[dict[str, str]] = []

          for config_path in sorted(scripts_root.glob("*/config.json")):
              namespace = config_path.parent.name
              zip_path = dist / f"{namespace}.zip"

              with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as archive:
                  for path in (scripts_root / namespace).rglob("*"):
                      if path.is_dir():
                          continue
                      rel_path = path.relative_to(scripts_root).as_posix()
                      archive.write(path, rel_path)

              namespaces.append(
                  {
                      "id": namespace,
                      "asset": zip_path.name,
                      "config": f"{namespace}/config.json",
                  }
              )

          index_payload = {"bundle_api_version": 1, "namespaces": namespaces}
          (dist / "namespaces.json").write_text(
              json.dumps(index_payload, indent=2) + "\n",
              encoding="utf-8",
          )
          PY

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
