name: Trigger ferp bundle build

on:
  push:
    branches: ["main"]

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch build to ferp
        env:
          GH_TOKEN: ${{ secrets.FERP_DISPATCH_TOKEN }}
          OWNER: zappbrandigan
          TARGET_REPO: ferp
          SCRIPTS_SHA: ${{ github.sha }}
          SCRIPTS_REF: ${{ github.ref }}
        run: |
          set -euo pipefail

          api="https://api.github.com/repos/${OWNER}/${TARGET_REPO}/dispatches"

          payload="$(jq -n \
            --arg event_type "scripts_push" \
            --arg scripts_repo "${{ github.repository }}" \
            --arg scripts_sha "${SCRIPTS_SHA}" \
            --arg scripts_ref "${SCRIPTS_REF}" \
            '{event_type: $event_type, client_payload: {scripts_repo: $scripts_repo, scripts_sha: $scripts_sha, scripts_ref: $scripts_ref}}'
          )"

          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "${api}" \
            -d "${payload}"

          echo "Dispatched scripts_sha=${SCRIPTS_SHA} to ${OWNER}/${TARGET_REPO}"
