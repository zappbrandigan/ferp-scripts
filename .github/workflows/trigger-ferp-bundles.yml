name: Trigger ferp bundle build

on:
  push:
    branches: ["main"]

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Compute changed script directories
        id: changes
        shell: bash
        run: |
          set -euo pipefail
      
          before="${{ github.event.before }}"
          after="${{ github.sha }}"
      
          # Handle first push edge case
          if [ "$before" = "0000000000000000000000000000000000000000" ]; then
            files="$(git ls-files)"
          else
            files="$(git diff --name-only "$before" "$after")"
          fi
      
          echo "Changed files:"
          printf '%s\n' "$files"
      
          # Script dirs live at repo root: ferp.<name>/...
          # Extract top-level directory names and keep only those that exist.
          dirs="$(printf '%s\n' "$files" \
            | awk -F/ 'NF>=2 {print $1}' \
            | sort -u \
            | while IFS= read -r d; do
                [ -n "$d" ] || continue
                [ -d "$d" ] || continue
                case "$d" in
                  ferp.*) echo "$d" ;;
                esac
              done \
            | jq -Rsc 'split("\n") | map(select(length>0))'
          )"
      
          echo "Changed dirs JSON: $dirs"
          echo "changed_dirs=$dirs" >> "$GITHUB_OUTPUT"

      - name: Dispatch build to ferp
        env:
          GH_TOKEN: ${{ secrets.FERP_DISPATCH_TOKEN }}
          OWNER: zappbrandigan
          TARGET_REPO: ferp
          SCRIPTS_SHA: ${{ github.sha }}
          SCRIPTS_REF: ${{ github.ref }}
          CHANGED_DIRS: ${{ steps.changes.outputs.changed_dirs }}
        run: |
          set -euo pipefail

          api="https://api.github.com/repos/${OWNER}/${TARGET_REPO}/dispatches"

          payload="$(jq -n \
            --arg event_type "scripts_push" \
            --arg scripts_repo "${{ github.repository }}" \
            --arg scripts_sha "${SCRIPTS_SHA}" \
            --arg scripts_ref "${SCRIPTS_REF}" \
            --argjson changed_dirs "${CHANGED_DIRS}" \
            '{event_type: $event_type, client_payload: {scripts_repo: $scripts_repo, scripts_sha: $scripts_sha, scripts_ref: $scripts_ref, changed_dirs: $changed_dirs}}'
          )"

          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            "${api}" \
            -d "${payload}"

          echo "Dispatched scripts_sha=${SCRIPTS_SHA} to ${OWNER}/${TARGET_REPO}"
          echo "Changed dirs: ${CHANGED_DIRS}"
